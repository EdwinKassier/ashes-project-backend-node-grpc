name: CI/CD Pipeline

on:
  push:
    branches:
      - develop
      - main
      - prod
    tags:
      - 'prod/v*.*.*'
  pull_request:
    branches:
      - main

env:
  PROJECT_ID: ${{ secrets.PROJECT_ID }}
  RUN_REGION: us-central1
  REPO_NAME: ${{ github.event.repository.name }}

jobs:
  # Lint and Type Check
  lint:
    name: Linting and Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma client
        run: pnpm db:generate

      - name: Type check
        run: pnpm typecheck

      - name: Lint
        run: pnpm lint

      - name: Format check
        run: pnpm format:check

  # Proto Lint
  proto-lint:
    name: Proto Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Buf
        uses: bufbuild/buf-setup-action@v1
        with:
          version: latest

      - name: Lint protos
        run: cd proto && buf lint

  # Tests
  test:
    name: Testing with Coverage
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma client
        run: pnpm db:generate

      - name: Run tests with coverage
        run: pnpm test:coverage
        env:
          DATABASE_URL: "postgresql://test:test@localhost:5432/test"

      - name: Check coverage threshold
        run: |
          # Coverage thresholds are enforced in vitest.config.ts
          echo "Coverage thresholds checked by Vitest"

  # Security Scanning
  security:
    name: Security Scanning
    needs: [lint]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run npm audit
        run: pnpm audit --audit-level=high || true

  # Build
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test, proto-lint]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma client
        run: pnpm db:generate

      - name: Build
        run: pnpm build

  # Deploy (only on prod tags)
  setup-build-deploy:
    name: Setup, Build, and Deploy
    runs-on: ubuntu-latest
    needs: [build, security]
    # Only run on tags matching prod/vX.X.X pattern
    if: startsWith(github.ref, 'refs/tags/prod/v')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        shell: bash
        id: extract_version
        run: |
          # Extract version from tag (e.g., prod/v0.0.1 -> v0.0.1)
          if [[ "$GITHUB_REF" == refs/tags/prod/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/prod/}
            echo "VERSION=$VERSION" >> $GITHUB_ENV
            echo "SERVICE_NAME=prod-${REPO_NAME}" >> $GITHUB_ENV
          else
            VERSION="latest"
            BRANCH_NAME=${GITHUB_REF#refs/heads/}
            echo "VERSION=$VERSION" >> $GITHUB_ENV
            echo "SERVICE_NAME=${BRANCH_NAME}-${REPO_NAME}" >> $GITHUB_ENV
          fi

      - name: Print deployment info
        run: |
          echo "Service Name: $SERVICE_NAME"
          echo "Version: $VERSION"
          echo "Region: $RUN_REGION"

      - name: Authenticate to Google Cloud
        id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.SA_KEY_JSON }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Use gcloud CLI'
        run: 'gcloud info'

      - name: Configure Docker for Artifact Registry
        run: |-
          gcloud auth configure-docker $RUN_REGION-docker.pkg.dev --quiet

      - name: Create Artifact Registry repository (if not exists)
        run: |-
          gcloud artifacts repositories create $REPO_NAME \
            --repository-format=docker \
            --location=$RUN_REGION \
            --description="Docker repository for $REPO_NAME" \
            --quiet || echo "Repository already exists"

      - name: Build and push container to Artifact Registry
        run: |-
          IMAGE_NAME="$RUN_REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$SERVICE_NAME:$VERSION"
          IMAGE_SHA="$RUN_REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$SERVICE_NAME:$GITHUB_SHA"

          docker build -t "$IMAGE_NAME" -t "$IMAGE_SHA" .
          docker push "$IMAGE_NAME"
          docker push "$IMAGE_SHA"

          echo "IMAGE=$IMAGE_NAME" >> $GITHUB_ENV

      - name: Deploy to Cloud Run (gRPC)
        run: |-
          gcloud run deploy "$SERVICE_NAME" \
            --quiet \
            --region "$RUN_REGION" \
            --image "$IMAGE" \
            --platform "managed" \
            --allow-unauthenticated \
            --memory "512Mi" \
            --cpu "1" \
            --max-instances "10" \
            --min-instances "0" \
            --port "50051" \
            --timeout "300" \
            --use-http2 \
            --set-env-vars "NODE_ENV=production,LOG_LEVEL=info"

      - name: Get Service URL
        id: get_service_url
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.RUN_REGION }} --format="value(status.url)")
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "Service URL: $SERVICE_URL"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Production Release ${{ env.VERSION }}
          body: |
            ## Production Release ${{ env.VERSION }}

            This release has been automatically deployed to production after passing all quality checks.

            ### Deployment Details
            - **Service**: ${{ env.SERVICE_NAME }}
            - **Version**: ${{ env.VERSION }}
            - **Region**: ${{ env.RUN_REGION }}
            - **Environment**: Production
            - **Service URL**: ${{ env.SERVICE_URL }}

            ### CI/CD Checks Passed
            - ✅ TypeScript type checking
            - ✅ ESLint linting
            - ✅ Prettier formatting
            - ✅ Proto linting (Buf)
            - ✅ Tests with coverage
            - ✅ Security scanning (npm audit)

            ### Changes
            See commit history for detailed changes.
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
